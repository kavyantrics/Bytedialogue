// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "postgresql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

enum UserRole {
  USER
  ADMIN
}

enum AccountStatus {
  ACTIVE
  SUSPENDED
  BANNED
}

model User {
  id            String    @id @default(cuid())
  kindeId       String?   @unique
  email         String?   @unique
  firstName     String?
  lastName      String?
  profileImage  String?
  role          UserRole  @default(USER)
  accountStatus AccountStatus @default(ACTIVE)
  emailVerified Boolean   @default(false)
  twoFactorEnabled Boolean @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  files         File[]
  messages      Message[]
  usageRecords  UsageRecord[]
  name          String?

  stripeCustomerId       String?   @unique @map(name: "stripe_customer_id")
  stripeSubscriptionId   String?   @unique @map(name: "stripe_subscription_id")
  stripePriceId          String?   @map(name: "stripe_price_id")
  stripeCurrentPeriodEnd DateTime? @map(name: "stripe_current_period_end")

  @@index([role])
  @@index([accountStatus])
  @@index([emailVerified])
}

enum UploadStatus {
  PENDING
  PROCESSING
  FAILED
  SUCCESS
}

model File {
  id            String    @id @default(cuid())
  name          String
  uploadStatus  UploadStatus @default(PENDING)
  url           String
  key           String
  size          Int?      // File size in bytes
  summary       String?   // Document summary
  isProcessed   Boolean   @default(false) // Whether embeddings are generated
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  messages      Message[]
  vectorChunks  VectorChunk[]

  @@index([userId])
  @@index([isProcessed])
  @@index([createdAt])
}

model Message {
  id             String   @id @default(cuid())
  text           String
  isUserMessage  Boolean
  followUpSuggestions String? // JSON array of suggested questions
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  userId         String
  fileId         String
  user           User     @relation(fields: [userId], references: [id])
  file           File     @relation(fields: [fileId], references: [id])

  @@index([userId])
  @@index([fileId])
  @@index([createdAt])
}

// Vector chunks for RAG implementation
model VectorChunk {
  id          String   @id @default(cuid())
  fileId      String
  content     String   // Text chunk
  embedding   String?  // JSON array of embedding vector (stored as string for now)
  metadata    String?  // JSON metadata (page number, position, etc.)
  createdAt   DateTime @default(now())
  file        File     @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@index([fileId])
}

// Usage tracking for AI tokens and file operations
model UsageRecord {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Token usage
  tokensUsed    Int      @default(0) // Total tokens used in this operation
  promptTokens  Int      @default(0) // Prompt tokens
  completionTokens Int   @default(0) // Completion tokens
  cost          Float    @default(0) // Cost in USD
  
  // Operation details
  operationType String   // 'chat', 'summary', 'embedding', 'transcription'
  fileId        String?  // Associated file if applicable
  messageId     String?  // Associated message if applicable
  
  // Time tracking
  month         Int      // 1-12
  year          Int      // e.g., 2024
  createdAt     DateTime @default(now())

  @@index([userId])
  @@index([year, month])
  @@index([createdAt])
  @@index([operationType])
}
